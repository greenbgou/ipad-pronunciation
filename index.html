<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±æ–‡ç™¼éŸ³ç·´ç¿’</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f5f7fb;
  margin: 0;
  padding: 20px;
  text-align: center;
}

h1 { font-size: 28px; }

button {
  font-size: 20px;
  padding: 14px 20px;
  margin: 8px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
}

.unit-btn {
  width: 90%;
  background: #5b8cff;
  color: white;
}

.card {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 420px;
  margin: 20px auto;
  box-shadow: 0 8px 20px rgba(0,0,0,.08);
}

.word { font-size: 36px; font-weight: bold; }
.zh { font-size: 24px; margin-top: 6px; }

.progress {
  font-size: 18px;
  color: #666;
}

.recording {
  color: red;
  font-size: 20px;
  margin: 10px 0;
}

.light {
  font-size: 26px;
  margin-top: 10px;
}

.star {
  font-size: 28px;
}

.back-btn { background: #eee; }
</style>
</head>

<body>

<h1>ğŸ“š é¸æ“‡å–®å…ƒ</h1>
<div id="menu"></div>
<div id="app"></div>

<script>
/* ğŸ”— æ›æˆä½ çš„ Google Sheet CSV */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1q3_RdZns6MIOL_WYZdUArXi-cy-98VLsdXP3YEEKUeg/gviz/tq?tqx=out:csv";

let allData = [];
let words = [];
let index = 0;

/* ===== è¼‰å…¥ Google Sheet ===== */
fetch(SHEET_URL)
  .then(r => r.text())
  .then(csv => {
    const rows = csv.split("\n").slice(1);
    allData = rows.map(r => {
      const [unit, unitTitle, en, zh, order] =
        r.split(",").map(s => s.replace(/"/g, ""));
      return { unit, unitTitle, en, zh, order };
    });
    showMenu();
  });

/* ===== é¸å–® ===== */
function showMenu() {
  document.getElementById("app").innerHTML = "";
  const menu = document.getElementById("menu");
  menu.innerHTML = "";

  const units = {};
  allData.forEach(d => units[d.unit] = d.unitTitle);

  Object.keys(units).forEach(u => {
    const b = document.createElement("button");
    b.className = "unit-btn";
    b.textContent = units[u];
    b.onclick = () => startUnit(u);
    menu.appendChild(b);
  });
}

/* ===== é–‹å§‹å–®å…ƒ ===== */
function startUnit(u) {
  words = allData.filter(d => d.unit === u)
                 .sort((a,b)=>a.order-b.order);
  index = 0;
  document.getElementById("menu").innerHTML = "";
  showCard();
}

/* ===== é¡¯ç¤ºå¡ç‰‡ ===== */
function showCard() {
  if (index >= words.length) {
    document.getElementById("app").innerHTML = `
      <h2>ğŸ‰ å…¨éƒ¨å®Œæˆï¼</h2>
      <div class="star">â­â­â­â­â­</div>
      <button class="back-btn" onclick="showMenu()">ğŸ”™ å›é¸å–®</button>
    `;
    return;
  }

  const w = words[index];
  document.getElementById("app").innerHTML = `
    <div class="card">
      <div class="progress">ç¬¬ ${index+1} é¡Œ / å…± ${words.length} é¡Œ</div>

      <div class="word">${w.en}</div>
      <div class="zh">${w.zh}</div>

      <button onclick="speak('${w.en}')">ğŸ”Š è½ç™¼éŸ³</button>
      <button onclick="record()">ğŸ¤ æˆ‘ä¾†å¿µ</button>

      <div id="status"></div>
      <div id="result"></div>

      <button onclick="next()">ä¸‹ä¸€é¡Œ</button><br>
      <button class="back-btn" onclick="showMenu()">ğŸ”™ å›é¸å–®</button>
    </div>
  `;
}

/* ===== TTS ===== */
function speak(t) {
  speechSynthesis.speak(new SpeechSynthesisUtterance(t));
}

/* ===== éŒ„éŸ³èˆ‡è©•åˆ† ===== */
function record() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return alert("æ­¤è£ç½®ä¸æ”¯æ´èªéŸ³è¾¨è­˜");

  const rec = new SR();
  rec.lang = "en-US";

  document.getElementById("status").innerHTML =
    `<div class="recording">ğŸ”´ éŒ„éŸ³ä¸­â€¦</div>`;
  document.getElementById("result").innerHTML = "";

  rec.start();

  rec.onresult = e => {
    document.getElementById("status").innerHTML = "";
    const said = e.results[0][0].transcript.toLowerCase();
    const ans = words[index].en.toLowerCase();

    let light="ğŸ”´", stars="â­", msg="å†è©¦è©¦çœ‹ï¼";
    if (said.includes(ans)) {
      light="ğŸŸ¢"; stars="â­â­â­"; msg="ä½ å¾ˆæ£’ï¼";
    } else if (similar(said, ans) > 0.5) {
      light="ğŸŸ¡"; stars="â­â­"; msg="å·®ä¸€é»ï¼Œå†è©¦è©¦çœ‹ï¼";
    }

    document.getElementById("result").innerHTML = `
      <div class="light">${light}</div>
      <div class="star">${stars}</div>
      <div>${msg}</div>
      <div>ğŸ—£ æˆ‘è½èµ·ä¾†åƒï¼š${said}</div>
    `;
  };
}

function next(){ index++; showCard(); }

function similar(a,b){
  let s=0;
  for(let i=0;i<Math.min(a.length,b.length);i++)
    if(a[i]==b[i]) s++;
  return s/Math.max(a.length,b.length);
}
</script>
</body>
</html>
