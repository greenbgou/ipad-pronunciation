<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è‹±æ–‡ç™¼éŸ³ç·´ç¿’ï½œè¡£æœå–®å­—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      text-align: center;
      background: #f7f7f7;
      padding: 20px;
    }
    h1 { margin-bottom: 5px; }
    h2 { margin-top: 0; color: #555; }
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .word {
      font-size: 36px;
      margin: 20px 0;
    }
    button {
      font-size: 20px;
      padding: 10px 16px;
      margin: 8px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
    }
    .mic { background: #ff5252; color: white; }
    .speak { background: #4caf50; color: white; }
    .result { margin-top: 16px; font-size: 18px; }
    .stars { font-size: 28px; margin-top: 8px; }
  </style>
</head>
<body>

<h1>ç¬¬ä¸€å–®å…ƒï¼šè¡£æœå–®å­—</h1>
<h2>Clothes</h2>

<div class="card">
  <div class="word" id="wordText"></div>

  <button class="speak" onclick="playTTS()">ğŸ”Š è½ç™¼éŸ³</button>
  <button class="mic" onclick="startRecognition()">ğŸ¤ éŒ„éŸ³</button>

  <div class="result" id="resultText"></div>
  <div class="stars" id="starsText"></div>
</div>

<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="failSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="cheerSound" src="https://actions.google.com/sounds/v1/crowds/large_crowd_cheer.ogg"></audio>

<script>
/* ===== é¡Œåº«ï¼ˆä½ ä»¥å¾Œåªæ”¹é€™è£¡ï¼‰===== */
const words = [
  { en: "sweater", zh: "æ¯›è¡£" },
  { en: "t-shirt", zh: "æ±—è¡«" },
  { en: "shirt", zh: "è¥¯è¡«" },
  { en: "dress", zh: "æ´‹è£" },
  { en: "jacket", zh: "å¤–å¥—" }
];

let currentIndex = 0;

/* ===== åˆå§‹åŒ– ===== */
updateWord();

/* ===== é¡¯ç¤ºç›®å‰é¡Œç›® ===== */
function updateWord() {
  document.getElementById("wordText").innerText =
    words[currentIndex].en + "ï¼ˆ" + words[currentIndex].zh + "ï¼‰";
  document.getElementById("resultText").innerText = "";
  document.getElementById("starsText").innerText = "";
}

/* ===== æ¨™æº–ç™¼éŸ³ ===== */
function playTTS() {
  const utter = new SpeechSynthesisUtterance(words[currentIndex].en);
  utter.lang = "en-US";
  speechSynthesis.speak(utter);
}

/* ===== èªéŸ³è¾¨è­˜ ===== */
function startRecognition() {
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("æ­¤è£ç½®ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ç”¨ Safari");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;

  recognition.onresult = (event) => {
    const spoken = event.results[0][0].transcript.toLowerCase().trim();
    evaluate(spoken);
  };

  recognition.start();
}

/* ===== æ ¸å¿ƒåˆ¤æ–· ===== */
function evaluate(spoken) {
  const answer = words[currentIndex].en.toLowerCase();

  document.getElementById("resultText").innerText =
    "æˆ‘è½èµ·ä¾†æ¯”è¼ƒåƒï¼š " + spoken;

  /* â­ includes() å¿«é€Ÿé€šé */
  if (spoken.includes(answer)) {
    document.getElementById("starsText").innerText = "â­â­â­";
    document.getElementById("successSound").play();

    setTimeout(nextWord, 1000);
    return;
  }

  /* â­ ç›¸ä¼¼åº¦ â†’ æ˜Ÿæ˜Ÿ */
  const similarity = calcSimilarity(spoken, answer);

  if (similarity >= 0.6) {
    document.getElementById("starsText").innerText = "â­â­";
  } else if (similarity >= 0.4) {
    document.getElementById("starsText").innerText = "â­";
  } else {
    document.getElementById("starsText").innerText = "âŒ å†è©¦ä¸€æ¬¡";
  }

  document.getElementById("failSound").play();
}

/* ===== ä¸‹ä¸€é¡Œ / å–®å…ƒå®Œæˆ ===== */
function nextWord() {
  currentIndex++;

  if (currentIndex >= words.length) {
    document.getElementById("wordText").innerText = "ğŸ‰ å–®å…ƒå®Œæˆï¼";
    document.getElementById("resultText").innerText = "å¤ªæ£’äº†ï¼";
    document.getElementById("starsText").innerText = "â­â­â­";
    document.getElementById("cheerSound").play();
    return;
  }

  updateWord();
}

/* ===== æ–‡å­—ç›¸ä¼¼åº¦ï¼ˆLevenshteinï¼‰===== */
function calcSimilarity(a, b) {
  const matrix = Array.from({ length: a.length + 1 }, () =>
    Array(b.length + 1).fill(0)
  );

  for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
  for (let j = 0; j <= b.length; j++) matrix[0][j] = j;

  for (let i = 1; i <= a.length; i++) {
    for (let j = 1; j <= b.length; j++) {
      matrix[i][j] =
        a[i - 1] === b[j - 1]
          ? matrix[i - 1][j - 1]
          : Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
    }
  }

  const distance = matrix[a.length][b.length];
  return 1 - distance / Math.max(a.length, b.length);
}
</script>

</body>
</html>
