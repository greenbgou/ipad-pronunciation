<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è‹±æ–‡ç™¼éŸ³ç·´ç¿’</title>

<style>
body {
  font-family: "Noto Sans TC", sans-serif;
  background: #f5f5f5;
  margin: 0;
}
#app {
  max-width: 480px;
  margin: auto;
  padding: 16px;
}
.card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-top: 16px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
button {
  font-size: 20px;
  padding: 12px;
  margin: 8px 0;
  width: 100%;
  border-radius: 12px;
  border: none;
}
.primary { background: #4caf50; color: white; }
.secondary { background: #2196f3; color: white; }
.gray { background: #ccc; }
</style>
</head>

<body>
<div id="app">è¼‰å…¥ä¸­â€¦</div>

<script>
/* ========= è¨­å®š ========= */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/1q3_RdZns6MIOL_WYZdUArXi-cy-98VLsdXP3YEEKUeg/gviz/tq?tqx=out:json";




/* ========= å…¨åŸŸç‹€æ…‹ ========= */
let data = [];
let units = {};
let currentUnit = null;
let index = 0;
let results = {};

/* ========= å·¥å…· ========= */
function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  speechSynthesis.speak(u);
}

function similarity(a,b){
  let same = 0;
  for(let i=0;i<Math.min(a.length,b.length);i++){
    if(a[i]===b[i]) same++;
  }
  return same / b.length;
}

/* ========= è¼‰å…¥ Sheet ========= */
fetch(SHEET_URL)
.then(r=>r.text())
.then(t=>{
  const json = JSON.parse(t.substring(47).slice(0,-2));
  json.table.rows.forEach(r=>{
    const [unit,unitTitle,en,zh,order] = r.c.map(c=>c.v);
    if(!units[unit]){
      units[unit]={title:unitTitle,words:[]};
    }
    units[unit].words.push({en,zh});
  });
  showMenu();
});

/* ========= é¸å–® ========= */
function showMenu(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>ğŸ“š å–®å…ƒé¸æ“‡</h2>
      ${Object.keys(units).map(u=>`
        <button class="primary" onclick="startUnit(${u})">
          ${units[u].title}
        </button>
      `).join("")}
    </div>
  `;
}

/* ========= å–®å…ƒ ========= */
function startUnit(u){
  currentUnit = units[u];
  index = 0;
  results = {};
  showWord();
}

/* ========= é¡Œç›® ========= */
function showWord(){
  if(index >= currentUnit.words.length){
    showReport();
    return;
  }
  const w = currentUnit.words[index];
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h3>${currentUnit.title}</h3>
      <h1>${w.en}</h1>
      <p>${w.zh}</p>

      <button class="secondary" onclick="speak('${w.en}')">ğŸ”Š è½ç™¼éŸ³</button>
      <button class="primary" onclick="record()">ğŸ¤ æˆ‘ä¾†å¿µ</button>

      <div id="status"></div>

      <button class="gray" onclick="index++;showWord()">ä¸‹ä¸€é¡Œ</button>
      <button class="gray" onclick="showMenu()">å›é¸å–®</button>
    </div>
  `;
}

/* ========= éŒ„éŸ³ ========= */
function record(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SR();
  rec.lang = "en-US";
  rec.start();

  document.getElementById("status").innerHTML = "ğŸ™ éŒ„éŸ³ä¸­â€¦";

  rec.onresult = e=>{
    const said = e.results[0][0].transcript.toLowerCase();
    const ans = currentUnit.words[index].en.toLowerCase();

    let stars="â­", msg="ğŸ’ª å†è©¦è©¦çœ‹ï¼", level="red";

    if(said.includes(ans)){
      stars="â­â­â­"; msg="ğŸ‰ ä½ å¾ˆæ£’ï¼"; level="green";
    }else if(similarity(said,ans)>0.5){
      stars="â­â­"; msg="ğŸ™‚ å·®ä¸€é»ï¼Œå†è©¦è©¦çœ‹ï¼"; level="yellow";
    }

    const prev = results[ans];
    if(!prev || (prev==="red" && level!=="red") || (prev==="yellow" && level==="green")){
      results[ans]=level;
    }

    document.getElementById("status").innerHTML = `
      <h2>${stars}</h2>
      <p>${msg}</p>
      <p>ğŸ—£ æˆ‘è½èµ·ä¾†åƒï¼š${said}</p>
    `;
  };
}

/* ========= å ±å‘Š ========= */
function showReport(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>ğŸ“Š æœ¬å–®å…ƒçµæœ</h2>
      ${currentUnit.words.map(w=>{
        const r = results[w.en]||"red";
        const icon = r==="green"?"ğŸŸ¢":r==="yellow"?"ğŸŸ¡":"ğŸ”´";
        return `<div>${icon} ${w.en}ï¼ˆ${w.zh}ï¼‰</div>`;
      }).join("")}
      <button class="primary" onclick="showMenu()">å›é¸å–®</button>
    </div>
  `;
}
</script>
</body>
</html>
