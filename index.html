<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±æ–‡ç™¼éŸ³ç·´ç¿’</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f5f7fb;
  margin: 0;
  padding: 20px;
  text-align: center;
}

h1 { font-size: 28px; }

button {
  font-size: 20px;
  padding: 14px 20px;
  margin: 8px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
}

.unit-btn {
  width: 90%;
  background: #5b8cff;
  color: white;
}

.card {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 420px;
  margin: 20px auto;
  box-shadow: 0 8px 20px rgba(0,0,0,.08);
}

.word { font-size: 36px; font-weight: bold; }
.zh { font-size: 24px; margin-top: 6px; }

.progress { font-size: 18px; color: #666; }
.recording { color: red; font-size: 20px; margin: 10px 0; }
.star { font-size: 28px; }
.light { font-size: 26px; }

.back-btn { background: #eee; }
</style>
</head>

<body>

<h1 id="title">ğŸ“š é¸æ“‡å–®å…ƒ</h1>
<div id="menu"></div>
<div id="app"></div>

<script>
/* ğŸ”— æ›æˆä½ çš„ Google Sheet ID */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/1q3_RdZns6MIOL_WYZdUArXi-cy-98VLsdXP3YEEKUeg/gviz/tq?tqx=out:json";

/* ===== åŒéŸ³å®¹å¿æ¸…å–®ï¼ˆåªå½±éŸ¿çŸ­å­—ï¼Œå¯è‡ªè¡ŒåŠ ï¼‰ ===== */
const phoneticFriends = {
  tea: ["tee","t"],
  tree: ["three"],
  rain: ["ran","ray"],
  pay: ["bay","play"],
  pete: ["peat","beat"]
};

let units = {};
let words = [];
let index = 0;
let results = {};

/* ===== è¼‰å…¥ Google Sheet ===== */
fetch(SHEET_URL)
  .then(r => r.text())
  .then(t => {
    const json = JSON.parse(t.substring(47).slice(0,-2));
    json.table.rows.forEach(r => {
      const [unit, unitTitle, en, zh, order] = r.c.map(c => c.v);
      if (!units[unit]) units[unit] = { title: unitTitle, words: [] };
      units[unit].words.push({ en, zh, order });
    });
    showMenu();
  });

/* ===== å–®å…ƒç¸½è¦½ ===== */
function showMenu(){
  document.getElementById("title").textContent = "ğŸ“š é¸æ“‡å–®å…ƒ";
  document.getElementById("app").innerHTML = "";
  const menu = document.getElementById("menu");
  menu.innerHTML = "";

  Object.keys(units).forEach(u => {
    const b = document.createElement("button");
    b.className = "unit-btn";
    b.textContent = units[u].title;
    b.onclick = () => startUnit(u);
    menu.appendChild(b);
  });
}

/* ===== é–‹å§‹å–®å…ƒ ===== */
function startUnit(u){
  words = units[u].words.sort((a,b)=>a.order-b.order);
  index = 0;
  results = {};
  document.getElementById("menu").innerHTML = "";
  document.getElementById("title").textContent = units[u].title;
  showCard();
}

/* ===== é¡¯ç¤ºå–®å­—å¡ ===== */
function showCard(){
  if (index >= words.length) {
    showReport();
    return;
  }

  const w = words[index];
  document.getElementById("app").innerHTML = `
    <div class="card">
      <div class="progress">ç¬¬ ${index+1} é¡Œ / å…± ${words.length} é¡Œ</div>
      <div class="word">${w.en}</div>
      <div class="zh">${w.zh}</div>

      <button onclick="speak('${w.en}')">ğŸ”Š è½ç™¼éŸ³</button>
      <button onclick="record()">ğŸ¤ æˆ‘ä¾†å¿µ</button>

      <div id="status"></div>
      <div id="result"></div>

      <button onclick="next()">ä¸‹ä¸€é¡Œ</button><br>
      <button class="back-btn" onclick="showMenu()">ğŸ”™ å›å–®å…ƒé¸å–®</button>
    </div>
  `;
}

/* ===== ç™¼éŸ³ ===== */
function speak(t){
  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(t));
}

/* ===== éŒ„éŸ³ï¼‹åˆ¤æ–· ===== */
function record(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return alert("æ­¤è£ç½®ä¸æ”¯æ´èªéŸ³è¾¨è­˜");

  const rec = new SR();
  rec.lang = "en-US";

  document.getElementById("status").innerHTML =
    `<div class="recording">ğŸ”´ éŒ„éŸ³ä¸­â€¦</div>`;
  document.getElementById("result").innerHTML = "";

  rec.start();

  rec.onresult = e => {
    document.getElementById("status").innerHTML = "";
    const said = e.results[0][0].transcript.toLowerCase().trim();
    const answer = words[index].en.toLowerCase().trim();

    let level="red", light="ğŸ”´", stars="â­", msg="å†è©¦è©¦çœ‹ï¼";

    if (said.includes(answer)) {
      level="green"; light="ğŸŸ¢"; stars="â­â­â­"; msg="ä½ å¾ˆæ£’ï¼";
    }
    else if (
      phoneticFriends[answer]?.includes(said) ||
      (answer.length >= 5 && similarity(said,answer) > 0.5)
    ) {
      level="yellow"; light="ğŸŸ¡"; stars="â­â­"; msg="å·®ä¸€é»ï¼Œå†è©¦è©¦çœ‹ï¼";
    }

    const prev = results[answer];
    if (!prev ||
        (prev==="red" && level!=="red") ||
        (prev==="yellow" && level==="green")) {
      results[answer] = level;
    }

    document.getElementById("result").innerHTML = `
      <div class="light">${light}</div>
      <div class="star">${stars}</div>
      <div>${msg}</div>
      <div>ğŸ—£ æˆ‘è½èµ·ä¾†åƒï¼š${said}</div>
    `;
  };
}

function next(){ index++; showCard(); }

/* ===== å–®å…ƒçµæœçµ±æ•´ ===== */
function showReport(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h2>ğŸ“Š æœ¬å–®å…ƒå­¸ç¿’çµæœ</h2>
      ${words.map(w=>{
        const key = w.en.toLowerCase().trim();
        const r = results[key] || "red";
        const icon = r==="green"?"ğŸŸ¢":r==="yellow"?"ğŸŸ¡":"ğŸ”´";
        return `<div>${icon} ${w.en}ï¼ˆ${w.zh}ï¼‰</div>`;
      }).join("")}
      <button class="back-btn" onclick="showMenu()">ğŸ”™ å›å–®å…ƒé¸å–®</button>
    </div>
  `;
}

/* ===== ç›¸ä¼¼åº¦ï¼ˆåªçµ¦é•·å­—ï¼‰===== */
function similarity(a,b){
  let s=0;
  for(let i=0;i<Math.min(a.length,b.length);i++)
    if(a[i]===b[i]) s++;
  return s/Math.max(a.length,b.length);
}
</script>
</body>
</html>
